# =============================================================================
# ArtisanPack UI Analytics Package CI/CD Pipeline
# =============================================================================
# This pipeline provides comprehensive testing, code quality checks, and
# automated releases for the Analytics package.
#
# Features:
# - Multi-PHP version testing (8.2, 8.3, 8.4)
# - Code coverage reporting
# - Static analysis (PHPStan)
# - Code style checking (PHP-CS-Fixer, PHPCS)
# - Security scanning (SAST, Secret Detection, Dependency Scanning)
# - Automated releases from tags
# - GitLab Pages for documentation
# =============================================================================

# -----------------------------------------------------------------------------
# Variables
# -----------------------------------------------------------------------------
variables:
  PHP_VERSION: "8.4"
  COMPOSER_HOME: /tmp/composer
  # Coverage settings
  COVERAGE_REPORT_PATH: coverage
  # Disable Xdebug for non-coverage jobs (faster)
  XDEBUG_MODE: "off"

# -----------------------------------------------------------------------------
# Workflow - Control when pipelines run
# -----------------------------------------------------------------------------
workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH

# -----------------------------------------------------------------------------
# Stages
# -----------------------------------------------------------------------------
stages:
  - build
  - test
  - code-quality
  - security
  - release
  - pages

# -----------------------------------------------------------------------------
# Security Scanning Templates
# -----------------------------------------------------------------------------
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

sast:
  stage: security

secret_detection:
  stage: security

dependency_scanning:
  stage: security

# -----------------------------------------------------------------------------
# Hidden Jobs (YAML Anchors for Reuse)
# -----------------------------------------------------------------------------

# Base PHP setup - extend this for jobs needing PHP
.php-setup:
  image: php:${PHP_VERSION}
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git unzip libzip-dev libsqlite3-dev
    - docker-php-ext-install zip pdo_sqlite
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer config --global gitlab-token.gitlab.com ${CI_JOB_TOKEN}

# PHP setup with Xdebug for coverage
.php-setup-coverage:
  image: php:${PHP_VERSION}
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git unzip libzip-dev libsqlite3-dev
    - docker-php-ext-install zip pdo_sqlite
    - pecl install xdebug && docker-php-ext-enable xdebug
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer config --global gitlab-token.gitlab.com ${CI_JOB_TOKEN}

# Cache configuration for Composer dependencies
.composer-cache:
  cache:
    key:
      files:
        - composer.json
      prefix: v1-${PHP_VERSION}
    policy: pull
    paths:
      - vendor/

# Rules for merge requests only
.merge-request-rules:
  rules:
    - if: $CI_MERGE_REQUEST_IID

# Rules for main branch and tags
.main-branch-rules:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# BUILD STAGE
# =============================================================================

build:vendors:
  extends:
    - .php-setup
  stage: build
  cache:
    key:
      files:
        - composer.json
      prefix: v1-${PHP_VERSION}
    policy: pull-push
    paths:
      - vendor/
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour
  script:
    - composer install --no-interaction --prefer-dist --optimize-autoloader
  interruptible: true

# =============================================================================
# TEST STAGE
# =============================================================================

# Main test job (PHP 8.4)
tests:
  extends:
    - .php-setup
    - .composer-cache
  stage: test
  needs:
    - job: build:vendors
      artifacts: true
  script:
    - ./vendor/bin/pest --ci
  interruptible: true

# Test with PHP 8.3
tests:php83:
  extends:
    - .php-setup
    - .composer-cache
  stage: test
  variables:
    PHP_VERSION: "8.3"
  needs:
    - job: build:vendors
      artifacts: true
  script:
    - ./vendor/bin/pest --ci
  allow_failure: true
  interruptible: true

# Test with PHP 8.2
tests:php82:
  extends:
    - .php-setup
    - .composer-cache
  stage: test
  variables:
    PHP_VERSION: "8.2"
  needs:
    - job: build:vendors
      artifacts: true
  script:
    - ./vendor/bin/pest --ci
  allow_failure: true
  interruptible: true

# Test with coverage (only on main branch and MRs to reduce resource usage)
tests:coverage:
  extends:
    - .php-setup-coverage
    - .composer-cache
  stage: test
  needs:
    - job: build:vendors
      artifacts: true
  variables:
    XDEBUG_MODE: coverage
  script:
    - ./vendor/bin/pest --ci --coverage --coverage-cobertura=coverage.xml --coverage-html=${COVERAGE_REPORT_PATH}
  coverage: '/^\s*Lines:\s*\d+\.\d+\%/'
  artifacts:
    paths:
      - ${COVERAGE_REPORT_PATH}/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 7 days
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  interruptible: true

# =============================================================================
# CODE QUALITY STAGE
# =============================================================================

php-cs-fixer:
  stage: code-quality
  image: php:${PHP_VERSION}
  needs:
    - job: build:vendors
      artifacts: true
  cache:
    key:
      files:
        - composer.json
      prefix: v1-${PHP_VERSION}
    policy: pull
    paths:
      - vendor/
  script:
    - PHP_CS_FIXER_IGNORE_ENV=1 ./vendor/bin/php-cs-fixer fix --dry-run --diff
  allow_failure: true
  interruptible: true

phpcs:
  stage: code-quality
  image: php:${PHP_VERSION}
  needs:
    - job: build:vendors
      artifacts: true
  cache:
    key:
      files:
        - composer.json
      prefix: v1-${PHP_VERSION}
    policy: pull
    paths:
      - vendor/
  before_script:
    - ./vendor/bin/phpcs --config-set installed_paths vendor/artisanpack-ui/code-style
  script:
    - ./vendor/bin/phpcs
  allow_failure: true
  interruptible: true

# PHPStan static analysis
phpstan:
  stage: code-quality
  image: php:${PHP_VERSION}
  needs:
    - job: build:vendors
      artifacts: true
  cache:
    key:
      files:
        - composer.json
      prefix: v1-${PHP_VERSION}
    policy: pull
    paths:
      - vendor/
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git unzip libzip-dev libsqlite3-dev
    - docker-php-ext-install zip pdo_sqlite
  script:
    - ./vendor/bin/phpstan analyse src --level=5 --no-progress --error-format=gitlab > phpstan-report.json || true
    - ./vendor/bin/phpstan analyse src --level=5 --no-progress
  artifacts:
    reports:
      codequality: phpstan-report.json
    expire_in: 7 days
  allow_failure: true
  interruptible: true

# =============================================================================
# RELEASE STAGE
# =============================================================================

# Extract release notes from CHANGELOG.md
prepare_release_description:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache grep sed bash
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      set -euxo pipefail

      echo "--- Preparing Release Description ---"
      echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"

      if [ ! -f "CHANGELOG.md" ]; then
        echo "Warning: CHANGELOG.md not found. Using default description."
        RELEASE_DESCRIPTION_FINAL="Release ${CI_COMMIT_TAG}. No CHANGELOG.md found."
      else
        # Extract version number from tag (v1.2.3 -> 1.2.3)
        RELEASE_VERSION=$(echo "${CI_COMMIT_TAG}" | sed 's/^v//')
        echo "Extracted RELEASE_VERSION: ${RELEASE_VERSION}"

        # Extract changelog section for this version
        START_MARKER="## \\[${RELEASE_VERSION}\\]"
        END_MARKER="## \\[[0-9]*\\.[0-9]*\\.[0-9]*\\]"

        CHANGELOG_CONTENT=$(sed -n "/${START_MARKER}/,/${END_MARKER}/p" CHANGELOG.md)

        if [ -z "${CHANGELOG_CONTENT}" ]; then
          TEMP_DESCRIPTION=""
        else
          TEMP_DESCRIPTION=$(echo "${CHANGELOG_CONTENT}" | \
            grep -v "${START_MARKER}" | \
            grep -v "${END_MARKER}" | \
            grep -v "^# Changelog" | \
            sed -e 's/^[[:space:]]*//' -e '/^$/d')
        fi

        if [ -z "${TEMP_DESCRIPTION}" ] || [ "${TEMP_DESCRIPTION}" = " " ]; then
          RELEASE_DESCRIPTION_FINAL="Release ${CI_COMMIT_TAG}. Refer to CHANGELOG.md for detailed changes."
        else
          RELEASE_DESCRIPTION_FINAL="${TEMP_DESCRIPTION}"
        fi
      fi

      echo "--- Release Description ---"
      echo "${RELEASE_DESCRIPTION_FINAL}"

      # Escape newlines for dotenv file
      ESCAPED_RELEASE_DESCRIPTION=$(echo "${RELEASE_DESCRIPTION_FINAL}" | sed -E ':a;N;s/\n/\\n/g;ta')
      echo "RELEASE_DESCRIPTION=${ESCAPED_RELEASE_DESCRIPTION}" > release.env
  artifacts:
    reports:
      dotenv: release.env

# Create GitLab Release
create_actual_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: prepare_release_description
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      set -euxo pipefail
      echo "--- Creating GitLab Release ---"
      echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"
      release-cli create \
        --name "Release ${CI_COMMIT_TAG}" \
        --tag-name "${CI_COMMIT_TAG}" \
        --description "${RELEASE_DESCRIPTION}"
      echo "Release created successfully."

# =============================================================================
# PAGES STAGE - Documentation
# =============================================================================

# Deploy documentation to GitLab Pages
pages:
  stage: pages
  image: python:3.11-alpine
  before_script:
    - pip install mkdocs mkdocs-material
  script:
    - mkdocs build --site-dir public
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: documentation
    url: https://jacob-martella-web-design.gitlab.io/artisanpack-ui/analytics
